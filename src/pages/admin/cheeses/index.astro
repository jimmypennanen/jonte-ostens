---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import Toast from '../../../components/Toast.astro';
import { getCheeses } from '../../../db/index';

export const prerender = false;

const cheeses = getCheeses();
---

<AdminLayout title="Hantera Ostar" currentPath="/admin/cheeses">
  <Toast />
  <div>
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-display font-bold text-dark-brown">
        Ostar
      </h1>
      <a href="/admin/cheeses/new" class="btn-primary">
        L√§gg till ny ost
      </a>
    </div>

    {cheeses.length === 0 ? (
      <div class="card text-center py-12">
        <p class="text-dark-brown/70 mb-4">Inga ostar √§nnu</p>
        <a href="/admin/cheeses/new" class="btn-primary inline-block">
          L√§gg till f√∂rsta ost
        </a>
      </div>
    ) : (
      <div class="card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-dark-green text-cream">
              <tr>
                <th class="text-left px-6 py-4 font-semibold">Namn</th>
                <th class="text-left px-6 py-4 font-semibold">Pris</th>
                <th class="text-left px-6 py-4 font-semibold">Beskrivning</th>
                <th class="text-right px-6 py-4 font-semibold">√Ötg√§rder</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-dark-brown/10">
              {cheeses.map(cheese => (
                <tr class="hover:bg-cream/50 transition-colors">
                  <td class="px-6 py-4 font-semibold text-dark-brown">
                    {cheese.name}
                  </td>
                  <td class="px-6 py-4 text-dark-brown/70">
                    {cheese.price}
                  </td>
                  <td class="px-6 py-4 text-dark-brown/70">
                    <p class="line-clamp-1">{cheese.description}</p>
                  </td>
                  <td class="px-6 py-4 text-right">
                    <div class="flex gap-2 justify-end">
                      <a
                        href={`/admin/cheeses/edit/${cheese.id}`}
                        class="px-3 py-1 bg-soft-yellow text-dark-brown rounded hover:bg-soft-yellow/80 text-sm font-semibold transition-colors"
                      >
                        Redigera
                      </a>
                      <button
                        class="delete-btn px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm font-semibold transition-colors"
                        data-id={cheese.id}
                      >
                        Ta bort
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    )}
  </div>

  <script>
    // Handle delete buttons
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const button = e.target as HTMLButtonElement;
        const id = button.dataset.id;

        if (!id) return;

        if (!confirm('√Ñr du s√§ker p√• att du vill radera denna ost?')) {
          return;
        }

        try {
          const response = await fetch(`/api/cheeses/${id}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            (window as any).showToast('Ost borttagen! üëã', { type: 'success' });
            setTimeout(() => window.location.reload(), 1500);
          } else {
            const error = await response.json();
            (window as any).showToast(error.error || 'Fel vid borttagning av ost', { type: 'error' });
          }
        } catch (error) {
          console.error('Delete error:', error);
          (window as any).showToast('Ett fel uppstod', { type: 'error' });
        }
      });
    });
  </script>
</AdminLayout>
