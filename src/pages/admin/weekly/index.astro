---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getCheeses, getCurrentWeeklyCheese, getWeek } from '../../../db/index';

export const prerender = false;

const cheeses = getCheeses();
const currentWeeklyCheese = getCurrentWeeklyCheese();
const currentWeek = getWeek(new Date());
const currentYear = new Date().getFullYear();

// Parse dont_pair_with if available
const dontPairWith = currentWeeklyCheese
  ? JSON.parse(currentWeeklyCheese.dont_pair_with_json || '[]')
  : [];
---

<AdminLayout title="Veckans Ost" currentPath="/admin/weekly">
  <div>
    <h1 class="text-3xl font-display font-bold text-dark-brown mb-8">
      Veckans Ost
    </h1>

    <div class="grid lg:grid-cols-2 gap-8">
      <!-- Current Weekly Cheese Info -->
      <div class="card bg-gradient-to-br from-soft-yellow/30 to-light-green/20">
        <h2 class="text-2xl font-display font-bold text-dark-brown mb-6">
          Nuvarande val
        </h2>

        {currentWeeklyCheese ? (
          <div class="space-y-4">
            <div>
              <p class="text-sm text-dark-brown/60 mb-1">Ost</p>
              <p class="text-2xl font-bold text-dark-brown">
                {currentWeeklyCheese.cheese_name}
              </p>
            </div>

            <div>
              <p class="text-sm text-dark-brown/60 mb-1">Vecka</p>
              <p class="text-lg text-dark-brown">
                Vecka {currentWeeklyCheese.week_number} av {currentWeeklyCheese.year}
              </p>
            </div>

            <div class="pt-4 border-t border-dark-brown/10">
              <p class="text-sm font-semibold text-dark-brown mb-2">Varför denna vecka?</p>
              <p class="text-sm text-dark-brown/80">
                {currentWeeklyCheese.why_selected}
              </p>
            </div>

            <div>
              <p class="text-sm font-semibold text-dark-brown mb-2">Hur äter man den?</p>
              <p class="text-sm text-dark-brown/80">
                {currentWeeklyCheese.how_to_eat}
              </p>
            </div>

            {dontPairWith.length > 0 && (
              <div>
                <p class="text-sm font-semibold text-dark-brown mb-2">PAIRA ALDRIG MED:</p>
                <ul class="text-sm text-dark-brown/80 space-y-1">
                  {dontPairWith.map((item: string) => (
                    <li>✗ {item}</li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        ) : (
          <p class="text-dark-brown/70">Ingen ost vald ännu för denna vecka</p>
        )}
      </div>

      <!-- Update Form -->
      <div class="card border-2 border-dark-green/20">
        <h2 class="text-2xl font-display font-bold text-dark-brown mb-6">
          Uppdatera veckans ost
        </h2>

        <form id="weekly-form" class="space-y-6">
          <div>
            <label for="cheese-id" class="block text-sm font-semibold text-dark-brown mb-2">
              Välj ost *
            </label>
            <select
              id="cheese-id"
              name="cheeseId"
              required
              class="w-full px-4 py-2 rounded-lg border-2 border-dark-brown/20 focus:border-dark-green focus:outline-none text-dark-brown"
            >
              <option value="">-- Välj en ost --</option>
              {cheeses.map(cheese => (
                <option value={cheese.id}>
                  {cheese.name} ({cheese.price})
                </option>
              ))}
            </select>
          </div>

          <div>
            <label for="description" class="block text-sm font-semibold text-dark-brown mb-2">
              Beskrivning *
            </label>
            <textarea
              id="description"
              name="description"
              required
              rows={3}
              class="w-full px-4 py-2 rounded-lg border-2 border-dark-brown/20 focus:border-dark-green focus:outline-none text-dark-brown resize-none"
              placeholder="Beskriv ostens egenskaper denna vecka..."
            ></textarea>
          </div>

          <div>
            <label for="why-selected" class="block text-sm font-semibold text-dark-brown mb-2">
              Varför denna vecka? *
            </label>
            <textarea
              id="why-selected"
              name="whySelected"
              required
              rows={3}
              class="w-full px-4 py-2 rounded-lg border-2 border-dark-brown/20 focus:border-dark-green focus:outline-none text-dark-brown resize-none"
              placeholder="Förklara varför denna ost valdes denna vecka..."
            ></textarea>
          </div>

          <div>
            <label for="how-to-eat" class="block text-sm font-semibold text-dark-brown mb-2">
              Hur äter man denna ost? *
            </label>
            <textarea
              id="how-to-eat"
              name="howToEat"
              required
              rows={3}
              class="w-full px-4 py-2 rounded-lg border-2 border-dark-brown/20 focus:border-dark-green focus:outline-none text-dark-brown resize-none"
              placeholder="Instruktioner för hur man njuter av denna ost..."
            ></textarea>
          </div>

          <div>
            <label for="dont-pair-with" class="block text-sm font-semibold text-dark-brown mb-2">
              PAIRA ALDRIG MED: *
            </label>
            <p class="text-xs text-dark-brown/60 mb-2">En sak per rad</p>
            <textarea
              id="dont-pair-with"
              name="dontPairWith"
              required
              rows={4}
              class="w-full px-4 py-2 rounded-lg border-2 border-dark-brown/20 focus:border-dark-green focus:outline-none text-dark-brown resize-none"
              placeholder="T.ex.&#10;Något sött&#10;Andra ostar&#10;Stark musik"
            ></textarea>
          </div>

          <div id="error-message" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4">
            <p id="error-text"></p>
          </div>

          <button
            type="submit"
            class="w-full bg-dark-green text-cream px-6 py-3 rounded-lg font-bold hover:bg-dark-green/90 transition-colors"
          >
            Spara veckans ost
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('weekly-form') as HTMLFormElement;
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');

    form?.addEventListener('submit', async (e: Event) => {
      e.preventDefault();

      const formData = new FormData(form);
      const cheeseId = parseInt(formData.get('cheeseId') as string, 10);
      const description = formData.get('description') as string;
      const whySelected = formData.get('whySelected') as string;
      const howToEat = formData.get('howToEat') as string;
      const dontPairWithText = formData.get('dontPairWith') as string;

      // Parse dont pair with - split by lines and filter empty
      const dontPairWith = dontPairWithText
        .split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0);

      if (dontPairWith.length === 0) {
        errorText!.textContent = 'Du måste lägga till minst en sak att paira med';
        errorMessage!.classList.remove('hidden');
        return;
      }

      try {
        const response = await fetch('/api/weekly/current', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            cheeseId,
            description,
            whySelected,
            howToEat,
            dontPairWith
          }),
        });

        if (response.ok) {
          // Reload page
          window.location.reload();
        } else {
          const error = await response.json();
          errorText!.textContent = error.error || 'Fel vid uppdatering';
          errorMessage!.classList.remove('hidden');
        }
      } catch (error) {
        errorText!.textContent = 'Ett fel uppstod. Försök igen senare.';
        errorMessage!.classList.remove('hidden');
        console.error('Form error:', error);
      }
    });
  </script>
</AdminLayout>
